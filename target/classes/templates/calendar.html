<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{layout :: head}">
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  </head>
  <body>
    <!-- Menú lateral -->

    <div id="main">
      <!-- Barra de navegación -->
      <div th:replace="~{layout :: nav}"></div>

      <!-- Contenido principal -->
      <main class="contentview" th:replace="~{layout :: content}">
        <section class="section-container" th:fragment="section">
          <header class="title">
            <div class="title-content">
              <h2>Gestiona tus accesos (Google Calendar)</h2>
              <button id="authButton">Conectar con Google Calendar</button>
            </div>
          </header>

          <div class="calendar" id="calendar"></div>

          <script>
            let accessToken = null;

            document
              .getElementById("authButton")
              .addEventListener("click", async () => {
                const clientId = "TU_CLIENT_ID";
                const redirectUri = window.location.origin + "/google-callback";
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly`;

                window.location.href = authUrl;
              });

            window.onload = function () {
              const params = new URLSearchParams(
                window.location.hash.substring(1)
              );
              if (params.has("access_token")) {
                accessToken = params.get("access_token");
                cargarEventosDesdeGoogleCalendar();
              }
            };

            async function cargarEventosDesdeGoogleCalendar() {
              if (!accessToken) return;

              const response = await fetch(
                "https://www.googleapis.com/calendar/v3/calendars/primary/events",
                {
                  headers: { Authorization: `Bearer ${accessToken}` },
                }
              );

              const data = await response.json();
              const eventos = data.items.map((evento) => ({
                title: evento.summary,
                start: evento.start.dateTime || evento.start.date,
                end: evento.end?.dateTime || evento.end?.date,
                id: evento.id,
              }));

              inicializarCalendario(eventos);
            }

            function inicializarCalendario(eventos) {
              const calendarEl = document.getElementById("calendar");
              const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: "dayGridMonth",
                headerToolbar: {
                  left: "prev,next today",
                  center: "title",
                  right: "dayGridMonth,timeGridWeek,timeGridDay",
                },
                events: eventos,
                dateClick: function (info) {
                  const title = prompt("Introduce el título del evento:");
                  if (title) {
                    crearEventoEnGoogleCalendar(title, info.dateStr, calendar);
                  }
                },
              });
              calendar.render();
            }

            async function crearEventoEnGoogleCalendar(
              title,
              dateStr,
              calendar
            ) {
              const nuevoEvento = {
                summary: title,
                start: { date: dateStr },
                end: { date: dateStr },
              };

              const response = await fetch(
                "https://www.googleapis.com/calendar/v3/calendars/primary/events",
                {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${accessToken}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(nuevoEvento),
                }
              );

              if (response.ok) {
                const eventoCreado = await response.json();
                calendar.addEvent({
                  title: eventoCreado.summary,
                  start: eventoCreado.start.date,
                  end: eventoCreado.end.date,
                  id: eventoCreado.id,
                });
                alert("Evento creado en Google Calendar");
              } else {
                alert("Error al crear evento");
              }
            }
          </script>
        </section>

        <!-- Footer -->
        <div th:replace="~{layout :: footer}"></div>
      </main>
    </div>
    <!-- Inclusión de los scripts del layout -->
    <script th:replace="~{layout :: scripts}"></script>
  </body>
</html>
