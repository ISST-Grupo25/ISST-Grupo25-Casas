<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{layout :: head}">
    <link rel="stylesheet" th:href="@{/css/calendar.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  </head>
  <body>
    <div id="main">
      <div th:replace="~{layout :: nav}"></div>
      <main class="contentview" th:replace="~{layout :: content}">
       
        <section class="section-container" th:fragment="section">
          <div id="calendar"></div>
          <button id="addEvent" class="btn">A√±adir Reserva</button>
          
          <!-- Fondo oscurecido cuando el modal est√° activo -->
          <div id="modalOverlay" class="modal-overlay" style="display: none;"></div>

          <!-- Modal oculto por defecto -->
          <div id="accessModal" class="modal" style="display: none;">
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>Nuevo Acceso</h2>
              <form id="accessForm">
                <label for="casa">Seleccionar Casa</label>
                <select id="casa" name="casa" required>
                  <option value="">Cargando casas...</option>
                </select>
              
                <label for="fecha">Fecha</label>
                <div class="date-picker-container">
                  <input type="text" id="fecha" name="fecha" class="date-range" required />
                  <span class="calendar-icon" id="openCalendar">üìÖ</span>
                </div>
                <label for="huespedes">Seleccionar Hu√©spedes</label>
                <select id="huespedes" name="huespedes" multiple required>
                  <option value="">Cargando hu√©spedes...</option>
                </select>
                <div class="modal-buttons">
                  <button type="button" class="btn cancel-btn">Cancelar</button>
                  <button type="submit" class="btn">Confirmar</button>
                </div>
              </form>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script th:replace="~{layout :: scripts}"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/es.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        console.log("‚úÖ JavaScript cargado correctamente");
        
        var casaSelect = document.getElementById('casa');
    var huespedSelect = document.getElementById('huespedes');

    // üìå **Cargar lista de Cerraduras (Casas)**
    fetch('/api/cerraduras')
      .then(response => response.json())
      .then(data => {
        casaSelect.innerHTML = ''; // Limpiar opciones anteriores
        data.forEach(cerradura => {
          let option = document.createElement('option');
          option.value = cerradura.id;
          option.textContent = cerradura.ubicacion; // Usamos la ubicaci√≥n como nombre
          casaSelect.appendChild(option);
        });
      })
      .catch(error => console.error("‚ùå Error al cargar casas:", error));

    // üìå **Cargar lista de Hu√©spedes**
    fetch('/api/huespedes')
      .then(response => response.json())
      .then(data => {
        huespedSelect.innerHTML = ''; // Limpiar opciones anteriores
        data.forEach(huesped => {
          let option = document.createElement('option');
          option.value = huesped.id;
          option.textContent = huesped.nombre; // Usamos el nombre del hu√©sped
          huespedSelect.appendChild(option);
        });
      })
      .catch(error => console.error("‚ùå Error al cargar hu√©spedes:", error));
  





        var dateInput = document.getElementById('fecha');
        var openCalendarIcon = document.getElementById('openCalendar');
        var calendarEl = document.getElementById('calendar');
        var modal = document.getElementById('accessModal');
        var modalOverlay = document.getElementById('modalOverlay');
        var closeModal = document.getElementsByClassName('close')[0];
        var cancelModal = document.querySelector('.cancel-btn');
    
        if (!dateInput || !openCalendarIcon) {
          console.error("‚ùå No se encontr√≥ el input o el icono üìÖ");
          return;
        }
    
        console.log("‚úÖ Elementos encontrados:", dateInput, openCalendarIcon);
    
        // üìå **Configuraci√≥n del calendario FullCalendar**
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          locale: 'es',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          events: '/api/reservas',
          eventClick: function (info) {
            alert('Reserva: ' + info.event.title + '\n' + info.event.extendedProps.description);
          }
        });
        calendar.render();
    
        // üìå **Funciones para abrir y cerrar el modal**
        function openModal() {
          modal.style.display = 'block';
          modalOverlay.style.display = 'block';
        }
    
        function closeModalFunction() {
          modal.style.display = 'none';
          modalOverlay.style.display = 'none';
        }
    
        document.getElementById('addEvent').addEventListener('click', openModal);
        closeModal.onclick = closeModalFunction;
        cancelModal.onclick = closeModalFunction;
    
        window.onclick = function (event) {
          if (event.target == modalOverlay) {
            closeModalFunction();
          }
        };
    
        // üìå **Flatpickr - Configuraci√≥n del selector de fechas**
        var datePicker = flatpickr(dateInput, {
          mode: "range",
          dateFormat: "d/m/Y",
          locale: flatpickr.l10ns.es,
          clickOpens: false, // No abrir al hacer clic en el input
          allowInput: true,
          appendTo: document.body, // Evita que el modal lo oculte
    
          // üìå **Se oculta por defecto hasta que se haga clic en el icono**
          onReady: function(selectedDates, dateStr, instance) {
            instance.calendarContainer.style.display = "none";
          },
    
          // üìå **Cuando se abre, aseguramos su visibilidad y posici√≥n**
          onOpen: function(selectedDates, dateStr, instance) {
            console.log("üìÜ Flatpickr se est√° abriendo...");
            let inputRect = dateInput.getBoundingClientRect();
            let calendar = instance.calendarContainer;
    
            calendar.style.display = "block"; // Asegurar que se muestra
            calendar.style.zIndex = "99999"; // Mayor que el modal
            calendar.style.position = "absolute";
            calendar.style.left = `${inputRect.right + 10}px`; // 10px a la derecha del input
            calendar.style.top = `${inputRect.top}px`;
            calendar.style.background = "white";
          },
    
          // üìå **Cuando se cierra, se vuelve a ocultar**
          onClose: function(selectedDates, dateStr, instance) {
            instance.calendarContainer.style.display = "none";
          }
        });
    
        // üìå **Abrir el DatePicker al hacer clic en el icono üìÖ**
        openCalendarIcon.addEventListener('click', function () {
          console.log("üìÖ Icono clickeado");
          datePicker.open();
        });
    
        // üìå **Manejo del formulario de reservas**
        document.getElementById('accessForm').addEventListener('submit', function (event) {
          event.preventDefault();
    
          var casa = document.getElementById('casa').value;
          var fecha = document.getElementById('fecha').value;
          var huespedes = Array.from(document.getElementById('huespedes').selectedOptions).map(option => option.value);
    
          // üìå **Validaci√≥n de fecha**
          var fechas = fecha.split(' - ');
          if (fechas.length !== 2) {
            alert("‚ùå Debes seleccionar un rango de fechas v√°lido.");
            return;
          }
    
          fetch('/api/reservas', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: casa,
              fechainicio: fechas[0],
              fechafin: fechas[1],
              huespedes: huespedes
            })
          })
          .then(response => response.json())
          .then(data => {
            console.log("‚úÖ Reserva a√±adida:", data);
            calendar.refetchEvents(); // Refresca las reservas
            closeModalFunction();
            alert('‚úÖ Acceso programado con √©xito y a√±adido a Google Calendar.');
          })
          .catch(error => console.error('‚ùå Error en la reserva:', error));
        });

        
    
      });
    </script>
    
  </body>
</html>

