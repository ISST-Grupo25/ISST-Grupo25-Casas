<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{layout :: head}"></head>
  <body>
    <div id="main">
      <div th:replace="~{layout :: nav}"></div>
      <main class="contentview" th:replace="~{layout :: content}">
       
        <section class="section-container" th:fragment="section">
          <div id="calendar"></div>
          <button id="addEvent" class="btn">Añadir Reserva</button>
          
          <!-- Fondo oscurecido cuando el modal está activo -->
          <div id="modalOverlay" class="modal-overlay" style="display: none;"></div>

          <!-- Modal oculto por defecto -->
          <div id="accessModal" class="modal" style="display: none;">
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>Programar Acceso</h2>
              <form id="accessForm">
                <label for="casa">Casa</label>
                <select id="casa" name="casa" required>
                  <option value="Casa 1">Casa 1</option>
                  <option value="Casa 2">Casa 2</option>
                  <option value="Casa 3">Casa 3</option>
                </select>
                <label for="fecha">Fecha</label>
                <input type="text" id="fecha" name="fecha" required />
                <label for="huespedes">Huespedes</label>
                <select id="huespedes" name="huespedes" multiple required>
                  <option value="Huesped 1">Huesped 1</option>
                  <option value="Huesped 2">Huesped 2</option>
                  <option value="Huesped 3">Huesped 3</option>
                </select>
                <div class="modal-buttons">
                  <button type="submit" class="btn">Confirmar</button>
                  <button type="button" class="btn cancel-btn">Cancelar</button>
                </div>
              </form>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script th:replace="~{layout :: scripts}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var modal = document.getElementById('accessModal');
        var modalOverlay = document.getElementById('modalOverlay');
        var closeModal = document.getElementsByClassName('close')[0];
        var cancelModal = document.querySelector('.cancel-btn');
        
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          locale: 'es',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          events: '/api/reservas', // Cargar reservas desde Spring Boot
          eventClick: function (info) {
            alert('Reserva: ' + info.event.title + '\n' + info.event.extendedProps.description);
          }
        });
        calendar.render();
        
        function openModal() {
          modal.style.display = 'block';
          modalOverlay.style.display = 'block';
        }
        
        function closeModalFunction() {
          modal.style.display = 'none';
          modalOverlay.style.display = 'none';
        }
        
        document.getElementById('addEvent').addEventListener('click', openModal);
        closeModal.onclick = closeModalFunction;
        cancelModal.onclick = closeModalFunction;
        
        window.onclick = function (event) {
          if (event.target == modalOverlay) {
            closeModalFunction();
          }
        };
        
        document.getElementById('accessForm').addEventListener('submit', function (event) {
          event.preventDefault();
          
          var casa = document.getElementById('casa').value;
          var fecha = document.getElementById('fecha').value;
          var huespedes = Array.from(document.getElementById('huespedes').selectedOptions).map(option => option.value);
          
          fetch('/api/reservas', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: casa,
              fechainicio: fecha.split(' - ')[0],
              fechafin: fecha.split(' - ')[1],
              huespedes: huespedes
            })
          }).then(response => response.json())
            .then(data => {
              calendar.refetchEvents();
              closeModalFunction();
              alert('Acceso programado con éxito y añadido a Google Calendar.');
            }).catch(error => console.error('Error:', error));
        });
      });
    </script>
  </body>
</html>

