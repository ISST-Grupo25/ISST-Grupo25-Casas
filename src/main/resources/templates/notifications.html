<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{layout :: head}"></head>
  <body th:class="${session.theme}">
    <div id="main">
      <!-- Barra de navegación -->
      <div th:replace="~{layout :: nav}"></div>

      <!-- Contenido principal -->
      <main class="contentview" th:replace="~{layout :: content}">
        <section class="notifications-container" th:fragment="section">
          <h2 style="text-align: center; margin-bottom: 2rem">
            Notificaciones de Acceso
          </h2>

          <div
            th:each="acceso : ${accesos}"
            th:class="'notification ' + (${acceso.resultado} ? 'success' : 'failure')"
            th:attr="data-id=${acceso.id}"
          >
            <div class="notification-icon">
              <span th:text="${acceso.resultado} ? '🔓' : '🔒'">🔓</span>
            </div>
            <div class="notification-content">
              <p>
                <strong th:text="${acceso.huesped.nombre}"
                  >Nombre del huésped</strong
                >
                <span th:if="${acceso.resultado}"> accedió a </span>
                <span th:unless="${acceso.resultado}"> intentó acceder a </span>
                <span
                  th:if="${acceso.reserva != null and acceso.reserva.cerradura != null}"
                  th:text="${acceso.reserva.cerradura.ubicacion}"
                >
                </span>

                <span th:if="${acceso.resultado}"> correctamente.</span>
                <span th:unless="${acceso.resultado}"> pero falló.</span>
              </p>
              <div class="notification-time" th:text="${acceso.horario}">
                01/05/2025 12:00
              </div>
            </div>
            <button class="discard-btn">Descartar</button>
          </div>

          <p
            th:if="${#lists.isEmpty(accesos)}"
            style="text-align: center; color: #999"
          >
            No tienes notificaciones por ahora 💤
          </p>
          <!-- botón borrar todas (estático) -->
        <div style="text-align:center; margin-top:2rem">
          <button id="clear-all-btn" class="btn btn-danger">Descartar todo</button>
        </div>
        </section>
        
      </main>
    </div>
    <!-- Scripts comunes del layout -->
    <script th:replace="~{layout :: scripts}"></script>

    <script>
      function refreshBadge() {
        const badge = document.querySelector('.notification-badge');
        const count = document.querySelectorAll('.notification').length;
        if (!badge) return;
        if (count > 0) {
          badge.textContent = count > 10 ? '(+10)' : '(' + count + ')';
        } else {
          badge.remove();         // si no quedan, quita la burbuja
        }
      }
    
      // handler “Descartar” individual
      document.querySelectorAll('.discard-btn').forEach(btn => {
        btn.addEventListener('click', async e => {
          const card = e.target.closest('.notification');
          const id = card.getAttribute('data-id');
          await fetch(`/notifications/dismiss/${id}`, { method: 'POST' });
          card.remove();           // quita la tarjeta
          refreshBadge();          // y actualiza la badge
        });
      });
    
      // botón “Eliminar todas las notificaciones”
      const allBtn = document.getElementById('clear-all-btn');
      allBtn.addEventListener('click', async () => {
        await fetch('/notifications/dismissAll', { method: 'POST' });
        document.querySelectorAll('.notification').forEach(n => n.remove());
        refreshBadge();           // actualiza la badge (se quitará)
      });
    </script>
  </body>
</html>
