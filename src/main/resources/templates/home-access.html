<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{layout :: head}"></head>
  <body>
    <div id="main">
      <!-- Barra de navegación -->
      <div th:replace="~{layout :: nav}"></div>

      <!-- Contenido principal -->
      <main class="contentview" th:replace="~{layout :: content}">
        <section class="section-container" th:fragment="section">
          <header class="key">
            <div class="key-content">
              <h2>Acceder a tu reserva actual</h2>
            </div>
          </header>
          <section class="houses">
            <div th:if="${reservas == null or reservas.isEmpty()}">
              <p>No tienes reservas activas.</p>
            </div>

            <div class="house" th:each="reserva : ${reservas}">
              <button class="key-btn" th:attr="data-pin=${reserva.pin}">
                <span class="material-icons">key</span>
              </button>
              <p th:text="'Ubicación: ' + ${reserva.cerradura.ubicacion}"></p>
              <p
                th:text="'Desde: ' + ${#dates.format(reserva.fechainicio, 'dd/MM/yyyy')} + ' hasta ' + ${#dates.format(reserva.fechafin, 'dd/MM/yyyy')}"
              ></p>
            </div>
          </section>
        </section>
      </main>
    </div>
    <!-- Modal para ingresar PIN -->
    <div id="pin-dialog" class="modal">
      <div class="modal-content">
        <h2>Ingresa tu código</h2>
        <input type="password" id="pin-input" maxlength="6" readonly />

        <div class="pin-keypad">
          <button class="pin-btn" data-value="1">1</button>
          <button class="pin-btn" data-value="2">2</button>
          <button class="pin-btn" data-value="3">3</button>
          <button class="pin-btn" data-value="4">4</button>
          <button class="pin-btn" data-value="5">5</button>
          <button class="pin-btn" data-value="6">6</button>
          <button class="pin-btn" data-value="7">7</button>
          <button class="pin-btn" data-value="8">8</button>
          <button class="pin-btn" data-value="9">9</button>
          <button class="pin-btn" id="clear-btn">←</button>
          <button class="pin-btn" data-value="0">0</button>
          <button class="pin-btn" id="blank-btn">AC</button>
        </div>

        <div class="pin-actions">
          <button id="cancel-btn">Cancelar</button>
          <button id="accept-btn">Aceptar</button>
        </div>
      </div>
    </div>

    <!-- Inclusión de los scripts del layout -->
    <script th:replace="~{layout :: scripts}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("pin-dialog");
        modal.style.display = "none";
        const pinInput = document.getElementById("pin-input");
        const buttons = document.querySelectorAll(".pin-btn");
        const openModalBtns = document.querySelectorAll(".key-btn");
        const cancelBtn = document.getElementById("cancel-btn");
        const clearBtn = document.getElementById("clear-btn");
        const acceptBtn = document.getElementById("accept-btn");
        const blankBtn = document.getElementById("blank-btn");

        let currentPin = null; // Variable para almacenar el PIN de la reserva seleccionada

        // Abrir modal y obtener el PIN de la reserva seleccionada
        openModalBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            currentPin = btn.getAttribute("data-pin"); // Obtener el PIN de la reserva
            modal.style.display = "flex";
            pinInput.value = "";
          });
        });

        // Cerrar modal
        cancelBtn.addEventListener("click", () => {
          modal.style.display = "none";
        });

        // Teclado numérico
        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            const value = button.getAttribute("data-value");

            if (value) {
              if (pinInput.value.length < 6) {
                pinInput.value += value;
              }
            }
          });
        });

        // Borrar último dígito
        clearBtn.addEventListener("click", () => {
          pinInput.value = pinInput.value.slice(0, -1);
        });

        // Borrar todo
        blankBtn.addEventListener("click", () => {
          pinInput.value = "";
        });

        // Aceptar PIN (Verificar si coincide con el PIN de la reserva)
        acceptBtn.addEventListener("click", () => {
          const pin = pinInput.value;
          if (pin.length >= 4) {
            console.log("PIN ingresado:", currentPin);
            if (pin === currentPin) {
              alert("PIN correcto. Acceso permitido.");
              modal.style.display = "none";
              triggerButtonAnimation(
                document.querySelector(`.key-btn[data-pin="${currentPin}"]`)
              );
            } else {
              alert("PIN incorrecto. Acceso denegado.");
            }
          } else {
            alert("El PIN debe tener al menos 4 dígitos.");
          }
        });

        // Función para reproducir la animación del botón
        function triggerButtonAnimation(button) {
          button.classList.add("hover-animation");
          setTimeout(() => {
            button.classList.remove("hover-animation");
          }, 600); // Duración de la animación (debe coincidir con la duración en CSS)
        }

        // Cerrar modal si se hace clic fuera
        window.addEventListener("click", (event) => {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        });
      });
    </script>
  </body>
</html>
